Микросервис для добавления информации от внешних поставщиков

Сборка
Заполнить env

В докере
Для локальной разработки использовать команду:
docker-compose -f docker-compose.yml -f docker-overlay.dev.yml up
Для развертывания в stage среде использовать команду:
docker-compose -f docker-compose.yml -f docker-overlay.stage.yml up -d

Локально
Для локальной разработки использовать

python3.8

poetry:

Установка зависимостей с помощью:
poetry install
Если не нужны зависимости разработки
poetry install --dev
Запуск сервера
uvicorn app.main:application --host 0.0.0.0 --port 8080 --reload

Доступность
В обоих случаях (докер или локальный запуск) API будет доступно по адресу
http://localhost:8080.

Style Guide
В качестве пакетного менеджера используется poetry. Конфигурацию определяют 3 файла:


pyproject.toml - основной конфиг для описания зависимостей.

poetry.lock - файл, фиксирующий зависимости

setup.cfg - конфиги, расширяющие описание pyproject.toml

На текущий момент следует использовать версию poetry==1.1.13.
Для добавления зависимостей следует указать комментарием группу и указать зависимость в соответствующем формате.
В проекте используется Style Guide от
wemake. Основным линтером
является flake8.
Конфиг для flake8 находится в файле setup.cfg. Он расширяет конфиг от wemake.
Для автоматизации процесса стандартизации кода следует использовать конфиг .editorconfig и
пайплайн из следующих плагинов автоформатирования:

autoflake

autoflake --in-place --remove-unused-variables --remove-all-unused-imports --expand-star-imports
Плагин не всегда работает верно, стоит следить за результатом.


docformatter - Форматирование docstrings

docformatter --in-place --wrap-summaries 120 --wrap-descriptions 120


unify - Приведение к единому виду кавычек

unify --in-place


autopep8 - Форматирование кода согласно PEP8. Конфиг в setup.cfg.

add-trailing-comma - Добавление запятых в конце в структурах типа
списков, словарей. Не требует специального конфига.

isort - Форматирование импортов. Конфиг находится в файле setup.cfg .

Для упрощения локальной работы с этим добавлен скрипт fmt.py.
С ним можно работать через командную строку указывая файл, который нужно поправить, и, если это необходимо, папку с
файлами плагинов. В pycharm можно использовать
либо external tools,
либо файл конфигурации.
Аналогично можно работать с flake8.
В дальнейшем планируются закрепление проверок с помощью bandit
и mypy.

Примеры настроек в PyCharm

Пример настройки external tools для автоформатирования


Включение поддержки .editotconfig


Ключи для провадйеров
В файле dotenv нужно добавить по ключу PROVIDER_API_KEYS json по типу:
{
  "Provider1": "w;erkbsdofjbsdmflsnxcvklxcbvlsd",
  "Provider2": "se;ltrnsdpbvzsdflbsd;jbsjdbf",
  "Provider3": "sdfklhsdfkjbsdljfbsjdfsjdvfbsjl"
}
По этому ключу провайдер данных будет получать доступ к микросервису. А мы на своей стороне будем однозначно определять
провайдера данных.

Термины и определения
Словарь перенесен в основной проект.

CI/CD
В pipeline CI/CD производится последовательный запуск:

проверка линтером
запуск тестов

Для отслеживания ошибок pipeline использовать интерфейс gitlab.
Выделены две ветки:

dev (отвечает за dev стенд)
master (отвечает за stage стенд и prod build)

Для деплоя необходимо добавить version в pyproject.toml.
Например "0.5.2". Здесь числовые значения соответствуют следующему:

0 - Мажорный релиз
5 - Минорный релиз
2 - Багфикс или другая коррректировка

Далее в интерфейсе gitlab необходимо создать тег, соответствующий version в pyproject.toml.
В случае успеха pipeline результат будет в списке gitlab container registry.